rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- helpers ----------
    function signedIn() { return request.auth != null; }

    function emailVerified() {
      return signedIn() && request.auth.token.email_verified == true;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function validRating() {
      return request.resource.data.value is int
        && request.resource.data.value >= 1
        && request.resource.data.value <= 5;
    }

    function validCommentText() {
      return request.resource.data.text is string
        && request.resource.data.text.size() >= 3
        && request.resource.data.text.size() <= 500;
    }

    function onlyKeys(allowed) {
      return request.resource.data.keys().hasOnly(allowed);
    }

    // =======================
    // PUBLIC GAME STATS
    // =======================
    match /games_public/{gameId} {
      // lo público se puede leer (si querés, después lo cerramos)
      allow read: if true;

      // Tu transacción hace "upsert" de este doc desde el cliente.
      // Permitimos create/update solo a emails verificados.
      allow create, update: if emailVerified()
        // si viene gameId en data, debe coincidir con la ruta
        && (!('gameId' in request.resource.data) || request.resource.data.gameId == int(gameId))
        && onlyKeys([
          'gameId','gameTitle','gameThumb',
          'ratingAvg','ratingCount',
          'commentCount',
          'updatedAt'
        ]);

      allow delete: if false;

      // =======================
      // RATINGS
      // =======================
      match /ratings/{uid} {
        allow read: if true;

        allow create: if emailVerified()
          && request.auth.uid == uid
          && validRating()
          && onlyKeys(['value','createdAt','updatedAt']);

        allow update: if emailVerified()
          && request.auth.uid == uid
          && validRating()
          && onlyKeys(['value','createdAt','updatedAt'])
          // createdAt no se toca
          && request.resource.data.createdAt == resource.data.createdAt;

        allow delete: if emailVerified() && request.auth.uid == uid;
      }

      // =======================
      // COMMENTS
      // =======================
      match /comments/{commentId} {
        allow read: if true;

        allow create: if emailVerified()
          && validCommentText()
          && request.resource.data.uid == request.auth.uid
          && onlyKeys([
            'gameId','gameTitle','gameThumb',
            'uid','displayName','text','createdAt','updatedAt'
          ]);

        allow update: if emailVerified()
          && isOwner(resource.data.uid)
          && validCommentText()
          // no cambiar dueño / gameId / createdAt
          && request.resource.data.uid == resource.data.uid
          && request.resource.data.gameId == resource.data.gameId
          && request.resource.data.createdAt == resource.data.createdAt
          && onlyKeys([
            'gameId','gameTitle','gameThumb',
            'uid','displayName','text','createdAt','updatedAt'
          ]);

        allow delete: if emailVerified() && isOwner(resource.data.uid);
      }
    }

    // =======================
    // USERS (perfil + prefs)
    // =======================
    match /users/{uid} {
      allow read: if isOwner(uid);

      // Permitimos guardar/actualizar perfil/prefs estando logueado.
      // (No hace falta email verificado para esto)
      allow create, update: if isOwner(uid)
        && onlyKeys([
          'uid',
          'displayName',
          'photoURL',
          'emailNotifications',
          'notifyOnReplies',
          'notifyOnMentions',
          'frequency',
          'updatedAt',
          'createdAt'
        ])
        && (!('uid' in request.resource.data) || request.resource.data.uid == request.auth.uid);

      allow delete: if false;
    }

    // =======================
    // USERNAMES (nombre único)
    // Doc id = nombre normalizado (ej: "yenza", "juanpi_20")
    // =======================
    match /usernames/{name} {
      allow read: if true;

      // Reservar nombre si NO existe
      allow create: if signedIn()
        && onlyKeys(['uid','displayName','createdAt'])
        && request.resource.data.uid == request.auth.uid;

      // Solo el dueño podría editar (idealmente NO se edita nunca)
      allow update: if isOwner(resource.data.uid)
        && onlyKeys(['uid','displayName','createdAt'])
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.createdAt == resource.data.createdAt;

      // No borrar (para mantener unicidad). Si querés liberar nombres, lo hacemos con Cloud Function admin.
      allow delete: if false;
    }
  }
}
